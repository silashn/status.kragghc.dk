@page
@model Status.Web.Pages.IndexModel
@{
}
<div id="TopContainer" class="Container">
    <div id="CPU_Container">
        <h3>CPU</h3>
        <div id="CPU_CanvasContainer">
        </div>
    </div>
    <div id="RAM_Container">
        <h3>RAM</h3>
        <div id="RAM"></div>
        <h3></h3>
    </div>
</div>

<div id="BottomContainer" class="Container">
    <div id="Disks_Container">
        <div id="Disks"></div>
    </div>
    <div id="Created"></div>
</div>

<script type="text/javascript">

    $(window).ready(function()
    {
        //var ctx = document.getElementById('CPU').getContext('2d');

        //var chart = new Chart(ctx, {

        //    type: 'line',

        //    data: {

        //        datasets: [{

        //            data: []

        //        }]

        //    },

        //    options: {

        //        scales: {

        //            xAxes: [{

        //                type: 'realtime',
        //                realtime:
        //                {
        //                    onRefresh: function(chart)
        //                    {
        //                        chart.data.datasets[0].data.push(
        //                            {
        //                                x: Date.now(),
        //                                y: Math.random()
        //                            });
        //                    }
        //                }

        //            }]

        //        }

        //    }

        //});
        Load();
    });
    //setInterval(Refresh, 5000);

    function Load()
    {
        $.ajax
            ({
                type: 'GET',
                url: '/Get/LatestHour',
                success: function(result)
                {
                    Chart.defaults.global.defaultFontColor = "#FFF";

                    var
                        aspectRatio = 2,
                        o = 0,
                        a = 3557500;

                    if ($(window).innerWidth() > 1024)
                    {
                        Chart.defaults.global.defaultFontSize = 18;
                    }
                    else
                    {
                        Chart.defaults.global.defaultFontSize = 12;
                        aspectRatio = 1;
                        o = 30;
                        a = a / 2;
                    }

                    $("#RAM").html(Math.round(result[result.length - 1].ram) + "%");
                    var disks = "";
                    for (var i = 0; i < result[result.length - 1].disks.length; i++)
                    {
                        disks += "<div class='disk'><div class='disk_deviceID'>" + result[result.length - 1].disks[i].deviceID + "</div><div class='disk_name'>" + result[result.length - 1].disks[i].name + "</div><div class='disk_freespace'><i>Plads tilbage:</i><br />" + Math.round(((result[result.length - 1].disks[i].freeSpace / 1024) / 1024) / 1024) + "GB</div><div class='disk_usedspace'><i>Plads brugt:</i><br />" + Math.round(((result[result.length - 1].disks[i].size - result[result.length - 1].disks[i].freeSpace) / result[result.length - 1].disks[i].size) * 100) + "%</div></div>";
                    }
                    $("#Disks").html(disks);
                    $("#Created").html(result[result.length - 1].time.replace("-", "/").replace("-", "/"));



                    var config =
                    {
                        type: 'line',
                        data:
                        {
                            datasets:
                                [{
                                    backgroundColor: "#c50c51",
                                    borderColor: "#c50c51",
                                    borderWidth: 0,
                                    lineTension: 0.4,
                                    borderJoinStyle: "round",
                                    borderCapStyle: "round",
                                    fill: true
                                }]
                        },
                        options:
                        {

                            animation: false,
                            legend:
                            {
                                display: false
                            },
                            responsive: true,
                            aspectRatio: aspectRatio,
                            tooltips:
                            {
                                mode: 'index',
                                intersect: false,
                                displayColors: false,
                                xAlign: "center",
                                yAlign: "center",
                                bodyAlign: "center",
                                footerAlign: "center",
                                callbacks:
                                {
                                    label:
                                        function(tooltipItem, data)
                                        {
                                            var label = tooltipItem.value + "%";
                                            return label;
                                        }
                                }
                            },
                            hover:
                            {
                                mode: 'index',
                                intersect: false
                            },
                            scales:
                            {
                                xAxes:
                                    [{
                                        display: true,
                                        scaleLabel:
                                        {
                                            display: false,
                                            labelString: 'Time'
                                        },
                                        type: 'realtime',
                                        realtime:
                                        {
                                            duration: a,
                                            refresh: 1000,
                                            delay: 2000,
                                            onRefresh: function(chart)
                                            {
                                                $.ajax
                                                    ({
                                                        type: 'GET',
                                                        url: '/Get/LatestReading',
                                                        success: function(result)
                                                        {
                                                            if (chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1].x != result.created)
                                                            {
                                                                chart.data.datasets[0].data.push
                                                                    (
                                                                        {
                                                                            x: result.created.replace("T", " ").substring(0, result.created.lastIndexOf(".")),
                                                                            y: result.cpu,
                                                                        }
                                                                    );
                                                            }

                                                            if ($(window).innerWidth() > 1024)
                                                            {
                                                                Chart.defaults.global.defaultFontSize = 18;
                                                                window.myLine.options.aspectRatio = 2;
                                                                window.myLine.options.scales.xAxes[0].realtime.duration = 3557500;
                                                            }
                                                            else
                                                            {
                                                                Chart.defaults.global.defaultFontSize = 12;
                                                                window.myLine.options.aspectRatio = 1;
                                                                window.myLine.options.scales.xAxes[0].realtime.duration = 1778750;
                                                            }
                                                        }
                                                    });
                                            }
                                        },
                                        time:
                                        {
                                            displayFormats:
                                            {
                                                millisecond: 'HH:mm',
                                                second: 'HH:mm',
                                                minute: 'HH:mm',
                                                hour: 'HH:mm',
                                                day: 'HH:mm',
                                                week: 'HH:mm',
                                                month: 'HH:mm',
                                                quarter: 'HH:mm',
                                                year: 'HH:mm',
                                            }
                                        }
                                    }],
                                yAxes:
                                    [{
                                        ticks:
                                        {
                                            min: 0,
                                            max: 100
                                        },
                                        display: true,
                                        scaleLabel:
                                        {
                                            display: false,
                                            labelString: '% CPU Usage'
                                        }
                                    }]
                            },
                            elements:
                            {
                                point:
                                {
                                    radius: 0
                                }
                            }
                        }
                    };

                    $("#CPU_CanvasContainer").append("<canvas id='CPU' aria-label='CPU Chart' role='chart'></canvas>");

                    var div = document.getElementById("CPU");
                    var ctx = div.getContext('2d');

                    window.myLine = new Chart(ctx, config);

                    for (o; o < result.length; o++)
                    {
                        window.myLine.data.datasets[0].data.push(
                            {
                                x: result[o].created.replace("T", " ").substring(0, result[o].created.lastIndexOf(".")),
                                y: result[o].cpu
                            });
                    }

                    window.myLine.update();
                },
                error: function(e)
                {
                    console.log("error:");
                    console.log(e);
                }
            });
    }

    function Refresh()
    {
        var chart = window.myLine;
        $.ajax
            ({
                type: 'GET',
                url: '/Get/LatestHour',
                success: function(result)
                {
                    var
                        update = false,
                        o = 0;
                    if ($(window).innerWidth() > 1024)
                    {
                        if (chart.aspectRatio == 1)
                        {
                            Chart.defaults.global.defaultFontSize = 18;
                            chart.aspectRatio = 2;
                            update = true;
                        }
                    }
                    else
                    {
                        if (chart.aspectRatio == 2)
                        {
                            Chart.defaults.global.defaultFontSize = 12;
                            chart.aspectRatio = 1;
                            update = true;
                        }
                        o = 30;
                    }

                    var disks = "";
                    for (var i = 0; i < result[result.length - 1].disks.length; i++)
                    {
                        disks += "<div class='disk'><div class='disk_deviceID'>" + result[result.length - 1].disks[i].deviceID + "</div><div class='disk_name'>" + result[result.length - 1].disks[i].name + "</div><div class='disk_freespace'><i>Plads tilbage:</i><br />" + Math.round(((result[result.length - 1].disks[i].freeSpace / 1024) / 1024) / 1024) + "GB</div><div class='disk_usedspace'><i>Plads brugt:</i><br />" + Math.round(((result[result.length - 1].disks[i].size - result[result.length - 1].disks[i].freeSpace) / result[result.length - 1].disks[i].size) * 100) + "%</div></div>";
                    }

                    if ($("#RAM").html(Math.round(result[result.length - 1].ram)) + "%")
                        $("#RAM").html(Math.round(result[result.length - 1].ram) + "%");

                    if ($("#Disks").html() != disks)
                        $("#Disks").html(disks);

                    if ($("#Created").html() != result[result.length - 1].time.replace("-", "/").replace("-", "/"))
                        $("#Created").html(result[result.length - 1].time.replace("-", "/").replace("-", "/"));

                    //var time = [];
                    //var cpu = [];
                    //for (o; o < result.length; o++)
                    //{
                    //    time.push(result[o].time.substring(result[0].time.lastIndexOf(" ") + 1));
                    //    cpu.push(result[o].cpu);
                    //}

                    //if (chart.data.datasets[0].data != cpu)
                    //{
                    //    chart.data.datasets[0].data = cpu;
                    //    chart.data.labels = time;
                    //    update = true;
                    //}

                    //if (update)
                    //{
                    //    chart.update();
                    //}
                }
            });
    }
</script>
